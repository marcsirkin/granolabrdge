{% extends "base.html" %}

{% block title %}{{ meeting.title }} - Granola Bridge{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1>{{ meeting.title }}</h1>
    <div>
        {% if meeting.status.value in ['processed', 'failed', 'review'] %}
        <form method="post" action="/meetings/{{ meeting.id }}/reprocess"
              onsubmit="return confirm('Delete existing action items and reprocess this meeting?');"
              style="display: inline;">
            <button type="submit" class="btn btn-sm btn-warning">Reprocess</button>
        </form>
        {% endif %}
        <form method="post" action="/meetings/{{ meeting.id }}/delete"
              onsubmit="return confirm('Delete this meeting and all its action items?');"
              style="display: inline;">
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
        <a href="/meetings" class="btn btn-primary btn-sm">&larr; Back to Meetings</a>
    </div>
</div>

{% if llm_pending %}
<div class="card" style="background-color: var(--warning); color: #333;">
    <strong>Meeting saved.</strong> LLM extraction is pending - the LLM service was unavailable.
    <br>Use the "Process Unprocessed Meetings" button on the <a href="/">dashboard</a> when the LLM is available.
</div>
{% endif %}

{% if meeting.status.value == 'pending' %}
<div class="card" style="background-color: #fff3cd; border-left: 4px solid var(--warning);">
    <strong>Waiting for transcript.</strong> This meeting is waiting for the transcript to stabilize.
    <br>Processing will begin automatically once the transcript is complete.
</div>
{% elif meeting.status.value == 'ready' %}
<div class="card" style="background-color: #fff3cd; border-left: 4px solid var(--warning);">
    <strong>Ready for processing.</strong> This meeting is queued for LLM extraction.
    <br>Action items will be extracted shortly.
</div>
{% elif meeting.status.value == 'processing' %}
<div class="card" style="background-color: #cce5ff; border-left: 4px solid var(--info);">
    <strong>Processing...</strong> LLM extraction is in progress.
</div>
{% elif meeting.status.value == 'review' %}
<div class="card" style="background-color: #e0f2fe; border-left: 4px solid var(--primary);">
    <div class="flex-between">
        <div>
            <strong>Review action items.</strong>
            {% set pending_count = action_items|selectattr('status.value', 'equalto', 'pending')|list|length %}
            {{ pending_count }} item{% if pending_count != 1 %}s{% endif %} awaiting review.
            Use thumbs up to send to Trello, thumbs down to skip.
        </div>
        {% if pending_count > 0 %}
        <form method="post" action="/meetings/{{ meeting.id }}/approve-all" style="margin: 0;">
            <button type="submit" class="btn btn-primary btn-sm">Send All to Trello</button>
        </form>
        {% endif %}
    </div>
</div>
{% elif meeting.status.value == 'failed' and not llm_pending %}
<div class="card" style="background-color: #f8d7da; border-left: 4px solid var(--danger);">
    <strong>Processing failed.</strong> LLM extraction encountered an error.
    <br>You can try again using the "Reprocess" button above.
</div>
{% endif %}

<div class="card">
    <h3>Meeting Details</h3>
    <p><strong>Source:</strong>
        <span class="badge {% if meeting.source.value == 'granola' %}badge-info{% else %}badge-warning{% endif %}">
            {{ meeting.source.value }}
        </span>
    </p>
    <p><strong>Status:</strong>
        {% if meeting.status.value == 'processed' %}
        <span class="badge badge-success">Processed</span>
        {% elif meeting.status.value == 'processing' %}
        <span class="badge badge-info">Processing</span>
        {% elif meeting.status.value == 'review' %}
        <span class="badge badge-review">Needs Review</span>
        {% elif meeting.status.value == 'ready' %}
        <span class="badge badge-warning">Ready</span>
        {% elif meeting.status.value == 'failed' %}
        <span class="badge badge-danger">Failed</span>
        {% else %}
        <span class="badge badge-warning">Pending</span>
        {% endif %}
    </p>
    {% if meeting.meeting_date %}
    <p><strong>Meeting Date:</strong> {{ meeting.meeting_date.strftime('%Y-%m-%d %H:%M') }}</p>
    {% endif %}
    <p><strong>Created:</strong> {{ meeting.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
    {% if meeting.processed_at %}
    <p><strong>Processed:</strong> {{ meeting.processed_at.strftime('%Y-%m-%d %H:%M') }}</p>
    {% endif %}
    {% if meeting.granola_id %}
    <p><strong>Granola ID:</strong> <code>{{ meeting.granola_id }}</code></p>
    {% endif %}
</div>

<div class="card">
    <div class="flex-between mb-2">
        <h3>Action Items ({{ action_items|length }})</h3>
        {% set pending_count = action_items|selectattr('status.value', 'equalto', 'pending')|list|length %}
        {% if pending_count > 0 and meeting.status.value != 'review' %}
        <form method="post" action="/meetings/{{ meeting.id }}/approve-all" style="margin: 0;">
            <button type="submit" class="btn btn-primary btn-sm">Send All to Trello</button>
        </form>
        {% endif %}
    </div>

    {% if action_items %}
    <div class="action-list">
        {% for item in action_items %}
        {% include "partials/action_item_row.html" %}
        {% endfor %}
    </div>
    {% else %}
    <p>No action items found in this meeting.</p>
    {% endif %}
</div>

<div class="card">
    <details>
        <summary style="cursor: pointer; font-weight: 600;">View Transcript</summary>
        <div class="transcript mt-2">{{ meeting.transcript }}</div>
    </details>
</div>
{% endblock %}
